# DAVID

Author: balobin.p@mail.ru
Version 0.5.0.dev
Date 07.07.19

************************************************************************************************************************
To Do list:
************************************************************************************************************************

Уровень идей:
1. Сделать словарь английского языка для детей на основе nltk.corpus.wordnet.
2. Добавить модуль диагностики состояния датчиков и базы данных. Модуль должен запускаться по голосовому сигналу и предоставлять голосовой отчет.
3. Модуль. Таймер. Создавать голосом задачу на установку таймера.
4. Модуль. Список покупок.
5. Модуль. Каша.
10. Сделать приветствие при получении сигнала с датчика открывания двери.
13. Добавить интеграцию с сайтом погоды и добавить воозможность запрашивать погоду голосом.
14. Установить датчик движения в коридор для определения когда кто-то пришел с улицы для приветствия.
18. Установить Splunk для контроля состояния по данным файлов логов.
23. Добавить возможность выполнения API запросов из внешней сети (либо запросов по WA).
22. Информирование по WA в случае срабатывания датчика движения входной двери.
24. Сделать задачи на неправильные глаголы для детей на сайте.
25. Сделать базу данных по категориям для детей на сайте, чтобы дети могли собирать материал по исследовательским темам.

Главный Компьютер:
25. Проверить во всех модулях и SQL запросах, что при добавлении дополнительного датчика температуры не будет задвоения данных.
27. Добавить API на базе flask и flask_sqlalchemy для получения данных из базы данных.
28. Сделать модуль inform_user для взаимодействия с пользователями.

Модуль Django:
1. Упростить пароли
2. Сделать service для запуска django или перевести на Apache.
3. Решить проблему передачи данных между view для task01.
4. Решить проблему с первым входом на страницу Math, когда у пользователя нет ни одной решенной задачи в task02.
В этом случае выходит ошибка.

Модуль david_web_server:
1. Переделать, чтобы web server слушал не 80 порт а другой, в противном случае не запустить apach.

Модуль climate_check:
1.

Модуль david_gas_check:
2. Добавить два светодиода (зеленый и красный), которые управляются с NodeMCU в зависимости от значения данных с датчика газа.
3. Добавит датчик температуры.
4. Проверять значения датчика газа раз в 10 секунд. В случае превышения порогового значения отправлять оповещение на главный модуль. Также отправлять значение каждые 15 минут независимо от уровня значения.
5. Добавить в http запрос признак сообщения (аварийное/периодическое). В случае аварийного сообщения web_server должен включать оповещение.
6. В логгере заменить t на value

Модуль david_currency_check:
1. 

Модуль david_unittest:
1. 

Модуль david_healthcheck:
1. Решить проблему с проверкой двух и более датчиков температуры.
2. Доделать информирование пользователя.

Модуль david_user_interface:
1. 

Микроконтроллер NodeMcu01BedRoom:
1. Реализовать подключение к WiFi модулей ESP в цикле только для передачи информации, чтобы устранить лишнее излучение (???).
2. Добавить Deep sleep для модулей ESP с делью экономии энергии и устранения излучения (???).

Микроконтроллер NodeMcu02Gas:
1. Сделать.
2. Добавить датчик температуры.
3. В http запрос connect добавить версию прошивки.

Микроконтроллер NodeMcu03Door (датчик между входными дверями)
1. Увеличить таймер выключения света до 30 секунд.
3. В http запрос connect добавить версию прошивки.

Микроконтроллер NodeMcu04Entrance (датчик в коридоре)
1. Заменить датчик движения.
2. Разработать.
3. В http запрос connect добавить версию прошивки.

************************************************************************************************************************
Изменения версий и процедуры
************************************************************************************************************************
------------------------------------
Version 0.5.0.dev change list and installation procedure:
------------------------------------

Модуль david_web_server:
1. Сделана обработка получения версии прошивки от датчиков

Модуль david_user_interface:
1. Пароль от почты вынесен во внешний json файл
2. Добавлена возможность отправки html в майл.

Микроконтроллер NodeMcu01BedRoom:
1. Заменен датчик DHT11 на DHT22.
2. Вынесены номер сенсора и IP главного компютрера в переменные.
3. В http запрос connect добавлена версия прошивки.

Модуль Django:
1. Добавлено тестирование для children_math и mainpage
/david/WEB_UI>python manage.py test children_math.tests
/david/WEB_UI>python manage.py test mainpage.tests
2. Исправлена проблема с неправильным отображением прогресса выполнения задач Math task
3. Добавлено умножение в math_task01

************************************************************************************************************************
Описание проекта (скрипты и контроллеры)
************************************************************************************************************************
------------------------------------
Main server
------------------------------------
Рабочие (основные) модули Главного Компьютера
------------------------------------

Модуль david_web_server:
-----------------
Файл: david_web_server.py
Задача:
1. Принимает http запросы от микроконтроллеров.
2. Сохраняет полученные данные в базу данных.
3. Логирует события в файл.

Модуль david_user_interface
-----------------
Файл: david_user_interface.py

User Story:
Пользователь задает параметры оповещения.
Различные модули программы используют данный модуль для оповещения пользователя в соответствии с заданными параметрами.
Модуль реализован в виде класса. Методы класса информируют отдельных пользователей или всех пользователей.
В качестве параметров передаются каналы информирования, например, WhatsApp, голос и т.д.
Каждый метод возвращает: unsuccessful, successful, confirmed.
unsuccessful - в случае неуспешной попытки проинформировать пользователя по любой причине,
successful - сообщение отправлено, но подтверждение не получено или не предполагается,
confirmed - сообщение отправлено и получено подтерждение о доставке.
Каналы информирования:
а. Голосовое сообщение,
б. Информирование на сайте,
в. Информирование через GSM канал (вызов, смс),
г. Информирование через месенджер (WhatsApp и пр.) 

Use Case
Main success scenario

Extensions - сценарии ошибок.
Variations - варианты успешных сценариев.

Метод запуска:

Задача:
1. Получает задачу на информирование пользователя.
2. Делает попытку проинформировать пользоателя.
3. Возвращает результат.

Действия (для логирования):
а. Получает задачу на информирование пользователя: get_task
б. Делает попытку проинформировать пользоателя: inform_user_attempt
в. Возвращает результат: inform_user_result

Модуль Django Математика
-----------------
Логика:
(user story)
Пользователь заходит на сайт под своим аккаунтом, решает примеры чтобы получить оценку.
Администратор контролирует статистику решений.

(use case)
Main success scenario
Extensions - сценарии ошибок.
Variations - варианты успешных сценариев.

Метод запуска:

Задача:
1. 
2. 
3. 

Действия (для логирования):
а. 
б. 
в. 

Модуль david_climate_check
-----------------
Файл: david_climate_check.py
Задача:
1. Запрашивает климатические данные из базы данных david_db.sqlite.
2. Проигрывает голосовое оповещение в случае превышения заданных порогов.
3. Логирует события в файл.

Действия (для логирования):
а. Проверяет наличие файлов логов и звуковых сэмплов.
б. Читает базу данных.
в. Проигрывает звуковой файл.

Модуль david_currency_check
-----------------
Файл: david_currency_check.py
Логика:
Если новое значение в процентном отношении больше предыдущего
или новое значение выходит за границы нормальных значений, идет информирование во WA.

Метод запуска:
crontab

Задача:
1. Получает курс валют с сайта ЦБРФ.
2. Записывает полученный курс в базу данных.
3. Проверяет изменения курса валют.
4. Информирует пользователя по WA об изменениях.

Действия (для логирования):
а. Выполняет http запрос.
б. Записывает в базу данных.
в. Читает базу данных. Выполняет проверку полученных данных.
г. Отправляет сообщение в WA.

Модуль david_gas_check
-----------------
Файл: david_gas_check.py
Логика:

Метод запуска:
crontab

Задача:
1. Запрашивает данные измерения датчика газа из базы данных david_db.sqlite.
2. Проигрывает голосовое оповещение в случае превышения заданных порогов.
3. Логирует события в файл.

Действия (для логирования):
а. Проверяет наличие файлов логов и звуковых сэмплов: check_file
б. Читает базу данных: get_data_from_db
в. Проигрывает звуковой файл: play_audio

Модуль "Список покупок" (проект)
-----------------
Модуль анализа речи подает сигнал на GPIO порт главного компьютера.
При получении сигнала с GPIO порта активируется программа, которая дает отклик, например: "Слушаю".
Далее по команде "Запиши в список покупок" переключается в подпрограмму записи покупок и выдает ответ: "Записываю".
Далее дается наименование товара.
Модуль произносит услашанное и ждет подтверждения.
Если подтверждение получено, наименование записывается в базу с датой создания и идентификатором списка покупок.
Должна быть реализована возможность закрывать список покупок и получать список покупок в виде речи и в виде сообщения в WhatsApp.

Вспомогательные модули Главного Компьютера
------------------------------------
Модуль david_healthcheck
-----------------
Файл: david_healthcheck.py
Логика:

Метод запуска:
crontab, запрос пользователя.

Задача:
1. Проверяет наличие файла базы данных: check_file
2. Запрашивает данные измерения датчиков из базы данных david_db.sqlite.
3. Запрашивает данные процессорной загрузки и загрузки памяти.
4. Записывает полученные данные процессорной загрузки и загрузки памяти в базу данных.
5. Готовит информационное сообщение отчет для пользователя.

Действия (для логирования):
а. Проверяет наличие файлов логов, файла базы данных и звуковых сэмплов: check_file
б. Запрашивает данные измерения датчиков из базы данных david_db.sqlite: get_data_from_db
в. Запрашивает данные процессорной загрузки и загрузки памяти: system_check
г. Готовит информационное сообщение отчет для пользователя: healthcheck_report

Модуль david_unittest
-----------------
Файл: david_unittest.py

Метод запуска:
Ручной запуск

Задача:
1. Делает бэкап базы данных.
2. Выполняет тесты.
3. Восстанавливает базу данных из бэкапа.

Модуль david_lib
-----------------
Файл: david_lib.py

Метод запуска:
Импортируемая библиотека.

Задача:
1. Содержит переменные и функции, используемые другими модулями.

Модуль david_db_create
-----------------
Файл: david_db_create.py
Задача:
1. Создает базу данных david_db.sqlite.
2. Пересоздает базу данных david_db.sqlite.

Модуль voice_recorder
-----------------
Файл: voice_recorder.py
Задача:
Запись голосовых сэмплов для проигрывания на Главном Компьютере.

------------------------------------
Микроконтроллер NodeMcu01BedRoom
------------------------------------
Файл: NodeMcu01BedRoom.pde

Задача:
1. Считывает данные с датчика DHT11
2. Отправляет данные на Главный Компютер посредством http get запроса.

Элементная база:
1. NodeMcu,
2. DHT11 датчик температуры и влажности.

Схема подключения:

@startditaa

 +-------------+      +--------+
 |             |      |        |
 |   NodeMcu   |      |  DHT11 |
-+A0         D0+-     |        |
-+G          D1+-   +-+ +      |
-+VU         D2+----|-+OUT     |
-+S3         D3+- +-|-+ -      |
-+S2         D4+- | | +--------+
-+S1         3V+- | |
-+SC         G +- | |
-+S0         D5+- | |
-+SK         D6+- | |
-+G          D7+- | |
-+3V         D8+- | |
-+EN         RX+- | |
-+RST        TX+- | |
-+G          G +--+ |
-+VIN        3V+----+
 +------+------+
        |
        |
       USB

@endditaa

------------------------------------
Микроконтроллер NodeMcu02Gas
------------------------------------
Файл: 

Логика:

Задача:
1. Считывает данные с датчика газа.
2. Отправляет данные на Главный Компьютер посредством http get запроса.
http://192.168.1.44:80/gas;sensor=2&sensorValue=666

Элементная база: 
1. NodeMcu,
2. MQ-4 датчик газа.

Схема подключения:
@startditaa

  +-------------------------+
  | +---------------------+ |
  | |  +-------------+    | |  +--------+
  | |  |             |    | |  |        |
  | |  |   NodeMcu   |    | |  |  MQ-4  |
  | +--+A0         D0+-   | |  |        |
  |   -+G          D1+-   | +--+VCC     |
  |   -+VU         D2+  +-|----+GND     |
  |   -+S3         D3+- | +----+A0      |
  |   -+S2         D4+- |      +--------+
  |   -+S1         3V+- |
  |   -+SC         G +- |
  |   -+S0         D5+- |
  |   -+SK         D6+- |
  |   -+G          D7+- |
  |   -+3V         D8+- |
  |   -+EN         RX+- |
  |   -+RST        TX+- |
  |   -+G          G +--+
  +----+VIN        3V+-
       +------+------+
              |
              |
             USB

@endditaa

------------------------------------
Микроконтроллер NodeMcu03Door
------------------------------------
Файл: NodeMcu03Door.pde

Задача:
1. Считывает данные с датчика движения.
2. Отправляет события на Главный Компьютер посредством http get запросов.
3. Включает освещение по событиям с датчика движения.

Элементная база:
1. NodeMcu,
2. Датчик движения AM312,
3. Светодиод "желтая линза" 5 мм.,
4. Резистор 100 Ом (2 шт.),
5. Адаптер питания на 5 В.,
6. Блок питания с разъемом 5.5 х 2.1.

Схема подключения:
@startditaa

         +-------------+                     +----------+
         |             |                     |          |
         |   NodeMcu   |                     |   AM312  |
         |A0         D0|     +--------+      |          |
         |G          D1+-----+ 100 Om +---+  |          |
         |VU         D2+-+   +--------+ +-|--+OUT       |
         |S3         D3| |              | |  |          |
         |S2         D4| |   +--------+ | |  | VCC  GND |
         |S1         3V| +---+ 100 Om +-+ |  +---+--+---+
         |SC         G |     +--------+   |      |  |
         |S0         D5|                  |      |  |
         |SK         D6|                  |      |  |
         |G          D7|                  |      |  |
         |3V         D8|                  |      |  |
         |EN         RX|                  |      |  |
         |RST        TX|   +-----+        |      |  |
   +-----+G          G +---+ LED +--------+      |  |
   |   +-+VIN        3V|   +-----+               |  |
   |   | +-------------+                         |  |
   |   |                                         |  |
 ------+-----------------------------------------+----> VCC + 5V
   |                                                |
 --+------------------------------------------------+-> GND

@endditaa

------------------------------------
Микроконтроллер NodeMcu04Entrance (проект)
------------------------------------
Файл: 

Логика:
Датчик установлен в коридоре. При обнаружении движения включается светодиод и отправляется сообщение на главный компьютер.
Данные записываются в базу данных и логируются.
Далее идет проверка было ли в пределах 15-ти секунд перед этим срабатывание датчика NodeMcu03Door.
Если было, то через 25 секунд проигрывается приветствие.
В приветсвие можно добавить информацию о состоянии системы, климатические данные в квартире и пр. информацию.

Задача:
1. 
2. 
3. 

Элементная база:
1. NodeMcu,
2. Датчик движения AM312,
3. Светодиод "желтая линза" 5 мм.,
4. Резистор 100 Ом (2 шт.),
5. AC-DC преобразователь 5 В.,

Схема подключения:
